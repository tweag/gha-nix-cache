{
  "version": 3,
  "sources": ["../src/server.js"],
  "sourcesContent": [
    "const cache = await import('@actions/cache');\nconst child_process = await import('node:child_process');\nconst fs = await import('node:fs/promises');\nconst http = await import('node:http');\nconst io = await import('@actions/io');\nconst process = await import('node:process');\n\nprocess.default.on('uncaughtException', (error) => {\n\tconsole.error(error && error.stack ? error.stack : error);\n\t// eslint-disable-next-line unicorn/no-process-exit\n\tprocess.exit(1);\n});\n\nasync function setup() {\n\tconst logFile = await fs.open('stderr.log', 'a');\n\tprocess.stdout.write = process.stderr.write = logFile\n\t\t.createWriteStream()\n\t\t.write.bind(logFile);\n\n\tconst binDir = 'bin';\n\tawait io.mkdirP(binDir);\n\tfor (const binary of ['bash', 'ln']) {\n\t\t// eslint-disable-next-line no-await-in-loop\n\t\tawait fs.symlink(await io.which(binary), `${binDir}/${binary}`);\n\t}\n\n\tawait fs.symlink(`${import.meta.dirname}/../tarshim.sh`, `${binDir}/tar`);\n\tprocess.env.PATH = binDir;\n\n\tawait io.mkdirP('upload');\n\t// Force cache to restore to cwd\n\tdelete process.env.GITHUB_WORKSPACE;\n}\n\nasync function _save(name) {\n\tconst _cacheId = await cache.saveCache([name], name);\n}\n\nasync function restore(name) {\n\tconst child = child_process.fork(`${import.meta.dirname}/restore.js`, [], {\n\t\tenv: {...process.env, TARGET_FILE_NAME: name},\n\t});\n\tawait new Promise((resolve, reject) => {\n\t\tchild.on('close', (code, signal) => {\n\t\t\tif (code === 0) {\n\t\t\t\tresolve();\n\t\t\t} else if (signal) {\n\t\t\t\treject(new Error(`Child process stopped because of signal ${signal}`));\n\t\t\t} else {\n\t\t\t\treject(new Error(`Child process exited with code ${code}`));\n\t\t\t}\n\t\t});\n\t});\n}\n\nfunction getKey(url) {\n\tif (url.startsWith('/nar/')) {\n\t\treturn url.slice(5);\n\t}\n\n\treturn url.slice(1);\n}\n\nasync function handle(request, response) {\n\tif (request.method !== 'GET') {\n\t\tresponse.writeHead(400);\n\t\tresponse.end();\n\t\treturn;\n\t}\n\n\tconst key = getKey(request.url);\n\ttry {\n\t\tawait restore(key);\n\t\tconst f = await fs.open(key);\n\t\tresponse.writeHead(200);\n\t\tawait f.createReadStream().pipe(response);\n\t} catch (error) {\n\t\tif (error.code === 'ENOENT') {\n\t\t\tresponse.writeHead(404);\n\t\t\tresponse.end();\n\t\t\treturn;\n\t\t}\n\n\t\tresponse.writeHead(500);\n\t\tconsole.error(error && error.stack ? error.stack : error);\n\t\tresponse.end(error.message);\n\t}\n}\n\nfunction startServer() {\n\tconst server = http.createServer(handle);\n\tserver.listen(8080, () => {\n\t\tprocess.send('started');\n\t});\n}\n\nasync function watchAndUpload() {\n\tconst watcher = fs.watch('upload', {recursive: true});\n\tfor await (const event of watcher) {\n\t\tconsole.log(event);\n\t}\n}\n\nasync function main() {\n\tawait setup();\n\twatchAndUpload();\n\tstartServer();\n}\n\nawait main();\n"
  ],
  "mappings": "+CAAA,IAAM,EAAQ,KAAa,+BACrB,EAAgB,KAAa,8BAC7B,EAAK,KAAa,4BAClB,EAAO,KAAa,qBACpB,EAAK,KAAa,4BAClB,EAAU,KAAa,wBAE7B,EAAQ,QAAQ,GAAG,oBAAqB,CAAC,IAAU,CAClD,QAAQ,MAAM,GAAS,EAAM,MAAQ,EAAM,MAAQ,CAAK,EAExD,EAAQ,KAAK,CAAC,EACd,EAED,eAAe,CAAK,EAAG,CACtB,IAAM,EAAU,MAAM,EAAG,KAAK,aAAc,GAAG,EAC/C,EAAQ,OAAO,MAAQ,EAAQ,OAAO,MAAQ,EAC5C,kBAAkB,EAClB,MAAM,KAAK,CAAO,EAEpB,IAAM,EAAS,MACf,MAAM,EAAG,OAAO,CAAM,EACtB,QAAW,IAAU,CAAC,OAAQ,IAAI,EAEjC,MAAM,EAAG,QAAQ,MAAM,EAAG,MAAM,CAAM,EAAG,GAAG,KAAU,GAAQ,EAG/D,MAAM,EAAG,QAAQ,GAAG,YAAY,wBAAyB,GAAG,OAAY,EACxE,EAAQ,IAAI,KAAO,EAEnB,MAAM,EAAG,OAAO,QAAQ,SAEjB,EAAQ,IAAI,iBAOpB,eAAe,CAAO,CAAC,EAAM,CAC5B,IAAM,EAAQ,EAAc,KAAK,GAAG,YAAY,qBAAsB,CAAC,EAAG,CACzE,IAAK,IAAI,EAAQ,IAAK,iBAAkB,CAAI,CAC7C,CAAC,EACD,MAAM,IAAI,QAAQ,CAAC,EAAS,IAAW,CACtC,EAAM,GAAG,QAAS,CAAC,EAAM,IAAW,CACnC,GAAI,IAAS,EACZ,EAAQ,UACE,EACV,EAAO,IAAI,MAAM,2CAA2C,GAAQ,CAAC,MAErE,GAAO,IAAI,MAAM,kCAAkC,GAAM,CAAC,EAE3D,EACD,EAGF,SAAS,CAAM,CAAC,EAAK,CACpB,GAAI,EAAI,WAAW,OAAO,EACzB,OAAO,EAAI,MAAM,CAAC,EAGnB,OAAO,EAAI,MAAM,CAAC,EAGnB,eAAe,CAAM,CAAC,EAAS,EAAU,CACxC,GAAI,EAAQ,SAAW,MAAO,CAC7B,EAAS,UAAU,GAAG,EACtB,EAAS,IAAI,EACb,OAGD,IAAM,EAAM,EAAO,EAAQ,GAAG,EAC9B,GAAI,CACH,MAAM,EAAQ,CAAG,EACjB,IAAM,EAAI,MAAM,EAAG,KAAK,CAAG,EAC3B,EAAS,UAAU,GAAG,EACtB,MAAM,EAAE,iBAAiB,EAAE,KAAK,CAAQ,QAChC,EAAP,CACD,GAAI,EAAM,OAAS,SAAU,CAC5B,EAAS,UAAU,GAAG,EACtB,EAAS,IAAI,EACb,OAGD,EAAS,UAAU,GAAG,EACtB,QAAQ,MAAM,GAAS,EAAM,MAAQ,EAAM,MAAQ,CAAK,EACxD,EAAS,IAAI,EAAM,OAAO,GAI5B,SAAS,CAAW,EAAG,CAEtB,AADe,EAAK,aAAa,CAAM,EAChC,OAAO,KAAM,IAAM,CACzB,EAAQ,KAAK,SAAS,EACtB,EAGF,eAAe,CAAc,EAAG,CAC/B,IAAM,EAAU,EAAG,MAAM,SAAU,CAAC,UAAW,EAAI,CAAC,EACpD,cAAiB,KAAS,EACzB,QAAQ,IAAI,CAAK,EAInB,eAAe,CAAI,EAAG,CACrB,MAAM,EAAM,EACZ,EAAe,EACf,EAAY,EAGb,MAAM,EAAK",
  "debugId": "B0E48E9E9DB5713464756E2164756E21",
  "names": []
}